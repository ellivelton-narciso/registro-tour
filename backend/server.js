const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors'); 
const axios = require('axios');
const connection = require('./db/connection');
require('dotenv').config();

const app = express();
app.use(cors());
app.use(bodyParser.json());

app.post('/submit', (req, res) => {
  const { name, email, pokemonList, codigo } = req.body;

  if (!name || !email || !pokemonList) {
    return res.status(400).json({
      error: 'Dados inv치lidos. Certifique-se de preencher todos os campos.',
    });
  }

  const configQuery = 'SELECT qtdEscolha, enviarDiscord, hook FROM config LIMIT 1';

  connection.getConnection((err, conn) => {
    if (err) {
      console.error('Erro ao obter conex칚o do pool:', err);
      return res.status(500).json({ error: 'Erro ao conectar ao banco de dados.' });
    }

    conn.query(configQuery, (err, configResults) => {
      if (err) {
        conn.release();
        console.error('Erro ao buscar configura칞칚o no banco:', err);
        return res.status(500).json({ error: 'Erro ao buscar configura칞칚o do banco.' });
      }

      if (configResults.length === 0) {
        conn.release();
        return res.status(500).json({ error: 'Configura칞칚o n칚o encontrada.' });
      }

      const { qtdEscolha, enviarDiscord, hook } = configResults[0];

      if (pokemonList.length !== qtdEscolha) {
        conn.release();
        return res.status(400).json({
          error: `Dados inv치lidos. Certifique-se de selecionar exatamente ${qtdEscolha} Pok칠mon.`,
        });
      }

      let validCodigo = null;
      if (codigo) {
        const codigoQuery = 'SELECT COUNT(*) AS count FROM prizes WHERE codigo = ?';
        conn.query(codigoQuery, [codigo], (err, countResults) => {
          if (err) {
            conn.release();
            console.error('Erro ao verificar c칩digo na tabela prizes:', err);
            return res.status(500).json({ error: 'Erro ao verificar c칩digo no banco.' });
          }

          if (countResults[0].count > 0) {
            validCodigo = codigo;
          } else {
            validCodigo = null;
          }

          const insertQuery = 'INSERT INTO trainers (name, email, pokemon_list, codigo) VALUES (?, ?, ?, ?)';
          const values = [name, email, JSON.stringify(pokemonList), validCodigo];

          conn.query(insertQuery, values, async (err, results) => {
            if (err) {
              conn.release();

              if (err.code === 'ER_DUP_ENTRY') {
                if (err.message.includes('name')) {
                  return res.status(400).json({
                    error: 'O nome de usu치rio j치 est치 em uso. Caso j치 tenha se cadastrado e queira editar, fale com Vako/Elli para remover teu cadastro.',
                  });
                } else if (err.message.includes('email')) {
                  return res.status(400).json({
                    error: 'O contato j치 est치 em uso. Caso j치 tenha se cadastrado e queira editar, fale com Vako/Elli para remover teu cadastro.',
                  });
                }
              }
              console.error('Erro ao salvar dados no banco:', err);
              return res.status(500).json({ error: 'Erro ao salvar dados no banco de dados.' });
            }

            if (enviarDiscord && hook) {
              const webhookUrl = hook;
              const discordMessage = {
                content: `游꿀 **Novo Participante no Torneio!**\n游븸 Boa sorte ${name} !`,
              };

              try {
                await axios.post(webhookUrl, discordMessage);
                console.log(`Notifica칞칚o enviada ao Discord para o participante: ${name}`);
              } catch (discordErr) {
                console.error('Erro ao enviar notifica칞칚o ao Discord:', discordErr);
              }
            } else {
              console.log('Configura칞칚o de webhook n칚o encontrada ou desabilitada.');
            }

            conn.release();
            return res.status(200).json({ message: 'Dados enviados com sucesso!' });
          });
        });
      } else {
        validCodigo = null;

        const insertQuery = 'INSERT INTO trainers (name, email, pokemon_list, codigo) VALUES (?, ?, ?, ?)';
        const values = [name, email, JSON.stringify(pokemonList), validCodigo];

        conn.query(insertQuery, values, async (err, results) => {
          if (err) {
            conn.release();

            if (err.code === 'ER_DUP_ENTRY') {
              if (err.message.includes('name')) {
                return res.status(400).json({
                  error: 'O nome de usu치rio j치 est치 em uso. Caso j치 tenha se cadastrado e queira editar, fale com Vako/Elli para remover teu cadastro.',
                });
              } else if (err.message.includes('email')) {
                return res.status(400).json({
                  error: 'O contato j치 est치 em uso. Caso j치 tenha se cadastrado e queira editar, fale com Vako/Elli para remover teu cadastro.',
                });
              }
            }
            console.error('Erro ao salvar dados no banco:', err);
            return res.status(500).json({ error: 'Erro ao salvar dados no banco de dados.' });
          }

          if (enviarDiscord && hook) {
            const webhookUrl = hook;
            const discordMessage = {
              content: `游꿀 **Novo Participante no Torneio!**\n游븸 Boa sorte ${name} !`,
            };

            try {
              await axios.post(webhookUrl, discordMessage);
              console.log(`Notifica칞칚o enviada ao Discord para o participante: ${name}`);
            } catch (discordErr) {
              console.error('Erro ao enviar notifica칞칚o ao Discord:', discordErr);
            }
          } else {
            console.log('Configura칞칚o de webhook n칚o encontrada ou desabilitada.');
          }

          conn.release();
          return res.status(200).json({ message: 'Dados enviados com sucesso!' });
        });
      }
    });
  });
});

app.get('/getConfig', (req, res) => {
  const query = 'SELECT * FROM config LIMIT 1';

  connection.getConnection((err, conn) => {
    if (err) {
      console.error('Erro ao obter conex칚o do pool:', err);
      return res.status(500).json({ error: 'Erro ao conectar ao banco de dados.' });
    }

    conn.query(query, (err, results) => {
      conn.release();

      if (err) {
        console.error('Erro ao buscar dados do banco:', err);
        return res.status(500).json({ error: 'Erro ao buscar dados do banco de dados.' });
      }

      if (results.length === 0) {
        return res.status(404).json({ error: 'Nenhuma configura칞칚o encontrada.' });
      }

      const config = results[0];

      try {
        config.listaLimitado = JSON.parse(config.listaLimitado || '[]');
        config.listaBanido = JSON.parse(config.listaBanido || '[]');
      } catch (parseErr) {
        console.error('Erro ao analisar campos JSON:', parseErr);
        return res.status(500).json({ error: 'Erro ao processar dados da configura칞칚o.' });
      }

      return res.status(200).json(config);
    });
  });
});

app.post('/updateConfig', (req, res) => {
  const {
    titulo,
    titulo2,
    gen,
    sprites,
    qtdLimitado,
    qtdEscolha,
    hook,
    enviarDiscord,
    listaLimitado,
    listaBanido,
    encerrado
  } = req.body;

  // Validar os dados recebidos
  if (!titulo || !gen || !sprites || !qtdLimitado) {
    return res.status(400).json({ error: 'Dados inv치lidos. Verifique os campos obrigat칩rios.' });
  }

  const query = `UPDATE config SET 
    titulo = ?, 
    titulo2 = ?, 
    gen = ?, 
    sprites = ?,
    qtdEscolha = ?,
    qtdLimitado = ?, 
    hook = ?, 
    enviarDiscord = ?, 
    listaLimitado = ?, 
    listaBanido = ?,
    encerrado = ?
    WHERE id = 1`;

  const values = [
    titulo,
    titulo2 || '',
    gen,
    sprites,
    qtdEscolha,
    qtdLimitado,
    hook ? hook : '',
    enviarDiscord ? 1 : 0,
    JSON.stringify(listaLimitado || []),
    JSON.stringify(listaBanido || []),
    encerrado ? 1 : 0
  ];

  connection.getConnection((err, conn) => {
    if (err) {
      console.error('Erro ao obter conex칚o do pool:', err);
      return res.status(500).json({ error: 'Erro ao conectar ao banco de dados.' });
    }

    conn.query(query, values, (err, results) => {
      conn.release();

      if (err) {
        console.error('Erro ao atualizar configura칞칫es no banco:', err);
        return res.status(500).json({ error: 'Erro ao atualizar configura칞칫es no banco de dados.' });
      }

      return res.status(200).json({ message: 'Configura칞칫es atualizadas com sucesso!' });
    });
  });
});

app.post('/login', (req, res) => {
  const { user, password } = req.body;

  if (!user || !password) {
    return res.status(400).json({ error: 'Usu치rio e senha s칚o obrigat칩rios.' });
  }

  const query = 'SELECT * FROM usuarios WHERE user = ? LIMIT 1';
  connection.getConnection((err, conn) => {
    if (err) {
      console.error('Erro ao obter conex칚o do pool:', err);
      return res.status(500).json({ error: 'Erro ao conectar ao banco de dados.' });
    }

    conn.query(query, [user], (err, results) => {
      conn.release();

      if (err) {
        console.error('Erro ao consultar usu치rio no banco:', err);
        return res.status(500).json({ error: 'Erro ao consultar usu치rio no banco de dados.' });
      }

      if (results.length === 0) {
        return res.status(401).json({ error: 'Usu치rio incorreto.' });
      }

      const storedPassword = results[0].password;

      if (password === storedPassword) {
        return res.status(200).json({ success: true });
      } else {
        return res.status(401).json({ error: 'Senha incorreta.' });
      }
    });
  });
});

app.get('/getTrainers', (req, res) => {
  const query = 'SELECT * FROM trainers';

  connection.getConnection((err, conn) => {
    if (err) {
      console.error('Erro ao obter conex칚o do pool:', err);
      return res.status(500).json({ error: 'Erro ao conectar ao banco de dados.' });
    }

    conn.query(query, (err, results) => {
      conn.release();

      if (err) {
        console.error('Erro ao consultar dados no banco:', err);
        return res.status(500).json({ error: 'Erro ao consultar dados no banco de dados.' });
      }

      const trainers = results.map(trainer => {
        let pokemonList = [];
        try {
          pokemonList = JSON.parse(trainer.pokemon_list);
        } catch (parseErr) {
          console.error('Erro ao analisar lista de Pok칠mon:', parseErr);
        }
        return {
          id: trainer.id,
          name: trainer.name,
          email: trainer.email,
          pokemonList: pokemonList,
        };
      });

      return res.status(200).json(trainers);
    });
  });
});

app.post('/submitPrizes', (req, res) => {
  const { id, nome, codigo, pokemonList } = req.body;

  if (!nome || !codigo || !pokemonList) {
    return res.status(400).json({ error: 'Dados inv치lidos. Certifique-se de preencher todos os campos obrigat칩rios.' });
  }

  const pokemonListStr = JSON.stringify(pokemonList);

  connection.getConnection((err, conn) => {
    if (err) {
      console.error('Erro ao obter conex칚o do pool:', err);
      return res.status(500).json({ error: 'Erro ao conectar ao banco de dados.' });
    }

    if (id) {
      const updateQuery = `
        UPDATE prizes 
        SET nome = ?, codigo = ?, pokemon_list = ? 
        WHERE id = ?
      `;
      const values = [nome, codigo, pokemonListStr, id];

      conn.query(updateQuery, values, (err, results) => {
        conn.release();

        if (err) {
          if (err.code === 'ER_DUP_ENTRY') {
            return res.status(400).json({
              error: 'O nome ou c칩digo j치 existe em outro registro. Verifique os dados e tente novamente.',
            });
          }
          console.error('Erro ao atualizar pr칡mio:', err);
          return res.status(500).json({ error: 'Erro ao atualizar o pr칡mio no banco de dados.' });
        }

        if (results.affectedRows === 0) {
          return res.status(404).json({ error: 'Pr칡mio com o ID fornecido n칚o encontrado.' });
        }

        return res.status(200).json({ message: 'Pr칡mio atualizado com sucesso!' });
      });
    } else {
      const insertQuery = `
        INSERT INTO prizes (nome, codigo, pokemon_list) 
        VALUES (?, ?, ?)
      `;
      const values = [nome, codigo, pokemonListStr];

      conn.query(insertQuery, values, (err, results) => {
        conn.release();

        if (err) {
          if (err.code === 'ER_DUP_ENTRY') {
            return res.status(400).json({
              error: 'O nome ou c칩digo j치 existe. Verifique os dados e tente novamente.',
            });
          }
          console.error('Erro ao inserir pr칡mio:', err);
          return res.status(500).json({ error: 'Erro ao inserir o pr칡mio no banco de dados.' });
        }

        return res.status(201).json({ message: 'Pr칡mio criado com sucesso!', id: results.insertId });
      });
    }
  });
});

app.get('/getPrizes', (req, res) => {
  const { codigo } = req.query; // Obter o par칙metro 'codigo' da requisi칞칚o
  const query = codigo
      ? 'SELECT * FROM prizes WHERE codigo = ?'
      : 'SELECT * FROM prizes';

  connection.getConnection((err, conn) => {
    if (err) {
      console.error('Erro ao obter conex칚o do pool:', err);
      return res.status(500).json({ error: 'Erro ao conectar ao banco de dados.' });
    }

    conn.query(query, codigo ? [codigo] : [], (err, results) => {
      conn.release();

      if (err) {
        console.error('Erro ao consultar pr칡mios no banco:', err);
        return res.status(500).json({ error: 'Erro ao consultar pr칡mios no banco de dados.' });
      }

      const prizes = results.map(prize => ({
        id: prize.id,
        nome: prize.nome,
        codigo: prize.codigo,
        pokemonList: JSON.parse(prize.pokemon_list || '[]'),
      }));

      return res.status(200).json(prizes);
    });
  });
});





const port = process.env.PORT || 3000;
app.listen(port, () => {
  console.log(`Servidor rodando na porta ${port}`);
});
